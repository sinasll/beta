<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>$BLACK Mining</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Appwrite Web SDK -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@17.0.1"></script>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="header">
    <h1 class="logo">$BLACK</h1>
  </div>

  <div class="container">
    <!-- Global Stats -->
    <div class="card global-stats">
      <div class="stats-row">
        <div>Total Mined</div>
        <div><span id="mined">0.00</span> / 100,000,000 $BLACK</div>
      </div>
      <div class="stats-row">
        <div>Total Miners</div>
        <div><span id="totalminers">0</span></div>
      </div>
    </div>

    <!-- User Stats -->
    <div class="card">
      <h2 class="card-title">User</h2>
      <div class="stats-row">
        <div>Username</div>
        <div><span id="username">username</span></div>
      </div>
      <div class="stats-row">
        <div>Balance</div>
        <div><span id="balance">0.000</span> $BLACK</div>
      </div>
      <div class="stats-row">
        <div>Mining Power</div>
        <div>x<span id="power">1.0</span></div>
      </div>
      <div class="stats-row">
        <div>Your Code Submissions</div>
        <div><span id="submissionCount">0</span>/10</div>
      </div>
      <button class="button" id="upgradeButton">Upgrade Power</button>
      <button class="button" id="mineButton">Start Mining</button>
    </div>

    <!-- Daily Code Section -->
    <div class="card">
      <div class="stats-row">
        <h2 class="card-title">Daily Code</h2>
        <div><span id="dailyCode">XXXXXXXXXX</span></div>
      </div>
      <button class="button" id="copyCodeButton">Copy Code</button>
      <input type="text" id="submitCodeInput" placeholder="Enter 10-digit code" maxlength="10" />
      <button class="button" id="submitCodeButton">Submit Code</button>
    </div>

    <div class="countdown" id="countdown">Daily reset in 00:00:00</div>
  </div>

  <!-- Navigation Menu -->
  <nav class="nav-menu" id="nav-menu">
    <ul class="nav-list">
      <li><a href="index.html" class="active">MINE</a></li>
      <li><a href="leaders.html">LEADERS</a></li>
      <li><a href="earn.html">EARN</a></li>
      <li><a href="friends.html">FRIENDS</a></li>
      <li><a href="wallet.html">WALLET</a></li>
    </ul>
  </nav>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Initialize Telegram WebApp
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.MainButton.hide();
        Telegram.WebApp.BackButton.hide();

        // Check if user is authenticated
        if (!Telegram.WebApp.initDataUnsafe?.user) {
          showError('Please open this app through Telegram');
          return;
        }

        // Initialize Appwrite client
        const client = new Appwrite.Client();
        client
          .setEndpoint('https://cloud.appwrite.io/v1')
          .setProject('67fc2c5c002c9c00f778');

        // Set username from Telegram data
        const user = Telegram.WebApp.initDataUnsafe.user;
        document.getElementById('username').textContent = 
          user.username || `${user.first_name}${user.last_name ? ' ' + user.last_name : ''}`;

        // Load initial data
        await loadUserData();

        // Setup button event listeners
        document.getElementById('mineButton').addEventListener('click', startMining);
        document.getElementById('copyCodeButton').addEventListener('click', copyDailyCode);
        document.getElementById('submitCodeButton').addEventListener('click', submitCode);
        document.getElementById('upgradeButton').addEventListener('click', upgradePower);

      } catch (error) {
        console.error('Initialization error:', error);
        showError(`Initialization failed: ${error.message}`);
      }
    });

    async function loadUserData() {
      try {
        const response = await fetch('https://cloud.appwrite.io/v1/functions/67fc53f00dd975eb7c7f/exec', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-Init-Data': Telegram.WebApp.initData
          },
          body: JSON.stringify({ 
            action: 'getUserData',
            userId: Telegram.WebApp.initDataUnsafe.user.id.toString() 
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          // Update UI with received data
          document.getElementById('balance').textContent = data.balance.toFixed(3);
          document.getElementById('power').textContent = data.power.toFixed(1);
          document.getElementById('submissionCount').textContent = data.submissions;
          document.getElementById('dailyCode').textContent = data.dailyCode || 'XXXXXXXXXX';
          document.getElementById('mined').textContent = data.totalMined.toFixed(2);
          document.getElementById('totalminers').textContent = data.totalMiners;
        } else {
          throw new Error(data.error || 'Failed to load data');
        }

      } catch (error) {
        console.error('Load data error:', error);
        showError(`Failed to load data: ${error.message}`);
      }
    }

    async function startMining() {
      try {
        Telegram.WebApp.MainButton.showProgress();
        
        const response = await fetch('https://cloud.appwrite.io/v1/functions/67fc53f00dd975eb7c7f/exec', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-Init-Data': Telegram.WebApp.initData
          },
          body: JSON.stringify({ 
            action: 'startMining',
            userId: Telegram.WebApp.initDataUnsafe.user.id.toString() 
          })
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Mining failed');
        }

        Telegram.WebApp.showAlert('Mining started successfully!');
        document.getElementById('dailyCode').textContent = result.dailyCode;
        await loadUserData(); // Refresh data

      } catch (error) {
        console.error('Mining error:', error);
        showError(error.message);
      } finally {
        Telegram.WebApp.MainButton.hideProgress();
      }
    }

    function copyDailyCode() {
      const code = document.getElementById('dailyCode').textContent;
      if (code && code !== 'XXXXXXXXXX') {
        navigator.clipboard.writeText(code);
        Telegram.WebApp.showAlert('Code copied to clipboard!');
      } else {
        showError('No active mining code available');
      }
    }

    async function submitCode() {
      const code = document.getElementById('submitCodeInput').value.trim();
      if (!code || code.length !== 10) {
        showError('Please enter a valid 10-digit code');
        return;
      }

      try {
        Telegram.WebApp.MainButton.showProgress();
        
        const response = await fetch('https://cloud.appwrite.io/v1/functions/67fc53f00dd975eb7c7f/exec', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-Init-Data': Telegram.WebApp.initData
          },
          body: JSON.stringify({ 
            action: 'submitCode',
            userId: Telegram.WebApp.initDataUnsafe.user.id.toString(),
            code: code
          })
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Code submission failed');
        }

        Telegram.WebApp.showAlert('Code submitted successfully!');
        document.getElementById('submitCodeInput').value = '';
        await loadUserData(); // Refresh data

      } catch (error) {
        console.error('Submit code error:', error);
        showError(error.message);
      } finally {
        Telegram.WebApp.MainButton.hideProgress();
      }
    }

    async function upgradePower() {
      try {
        const result = await Telegram.WebApp.openInvoice({
          title: 'Upgrade Mining Power',
          description: 'Purchase a 2x mining power boost',
          currency: 'USD',
          prices: [
            { label: 'Power Boost', amount: '499' }
          ],
          payload: JSON.stringify({
            userId: Telegram.WebApp.initDataUnsafe.user.id.toString(),
            type: 'powerUpgrade'
          })
        });

        if (result.status === 'paid') {
          Telegram.WebApp.showAlert('Upgrade successful! Your mining power has been doubled.');
          await loadUserData();
        }

      } catch (error) {
        console.error('Upgrade error:', error);
        showError(`Upgrade failed: ${error.message}`);
      }
    }

    function showError(message) {
      Telegram.WebApp.showPopup({
        title: 'Error',
        message: message,
        buttons: [{ type: 'default', text: 'OK' }]
      }, () => {
        // Callback after popup is closed
      });
    }

    // Countdown timer for daily reset
    function updateCountdown() {
      const now = new Date();
      const resetTime = new Date();
      resetTime.setHours(24, 0, 0, 0); // Midnight reset
      
      const diff = resetTime - now;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      
      document.getElementById('countdown').textContent = 
        `Daily reset in ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    setInterval(updateCountdown, 1000);
    updateCountdown();
  </script>
  
</body>
</html>
