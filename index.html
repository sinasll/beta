<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>$BLACK Mining</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Firebase SDKs (using compat libraries) -->
  <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-functions-compat.js"></script>
</head>
<body>
  <div class="header">
    <h1 class="logo">$BLACK</h1>
  </div>

  <div class="container">
    <!-- Global Stats -->
    <div class="card global-stats">
      <div class="stats-row">
        <div>Total Mined</div>
        <div><span id="mined">0.00</span> / 100,000,000 $BLACK</div>
      </div>
      <div class="stats-row">
        <div>Total Miners</div>
        <div><span id="totalminers">0</span></div>
      </div>
      <div class="stats-row">
        <div>Active Miners</div>
        <div><span id="activeminers">0</span></div>
      </div>
    </div>

    <!-- User Stats -->
    <div class="card">
      <h2 class="card-title">User</h2>
      <div class="stats-row">
        <div>Username</div>
        <div><span id="username">username</span></div>
      </div>
      <div class="stats-row">
        <div>Balance</div>
        <div><span id="balance">0.000</span> $BLACK</div>
      </div>
      <div class="stats-row">
        <div>Mining Power</div>
        <div>x<span id="power">1.0</span></div>
      </div>
      <div class="stats-row">
        <div>Your Code Submissions</div>
        <div><span id="submissionCount">0</span>/10</div>
      </div>
      <button class="button" id="upgradeButton">Upgrade Power</button>
      <button class="button" id="mineButton">Start Mining</button>
    </div>

    <!-- Daily Code Section -->
    <div class="card">
      <div class="stats-row">
        <h2 class="card-title">Daily Code</h2>
        <div><span id="dailyCode">XXXXXXXXXX</span></div>
      </div>
      <button class="button" id="copyCodeButton">Copy Code</button>
      <input type="text" id="submitCodeInput" placeholder="Enter 10-digit code" maxlength="10" />
      <button class="button" id="submitCodeButton">Submit Code</button>
    </div>

    <div class="countdown" id="countdown">Daily reset in 00:00:00</div>
  </div>

  <!-- Upgrade Power Modal -->
  <div class="modal-overlay" id="upgradeModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Upgrade Mining Power</h3>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="power-option">
        <div class="power-info">
          <div class="power-name">Advanced Miner</div>
          <div class="power-desc">2x mining acceleration</div>
          <div class="power-price"><i class="fas fa-star"></i> 250 Stars</div>
        </div>
        <button class="power-buy" data-power="2" data-price="250">Upgrade</button>
      </div>
      <div class="power-option premium">
        <div class="power-info">
          <div class="power-badge">RECOMMENDED</div>
          <div class="power-name">Pro Miner</div>
          <div class="power-desc">5x mining acceleration</div>
          <div class="power-price"><i class="fas fa-star"></i> 500 Stars</div>
        </div>
        <button class="power-buy premium-btn" data-power="5" data-price="500">Upgrade</button>
      </div>
      <div class="power-option elite-highlight">
        <div class="elite-glow"></div>
        <div class="power-info">
          <div class="power-name">Elite Miner</div>
          <div class="power-desc">10x mining acceleration</div>
          <div class="power-price"><i class="fas fa-star"></i> 1000 Stars</div>
        </div>
        <button class="power-buy elite-btn" data-power="10" data-price="1000">Upgrade</button>
      </div>
      <div class="power-note">
        <i class="fas fa-info-circle"></i> Higher mining power = More $BLACK per minute
      </div>
    </div>
  </div>

  <!-- Navigation Menu -->
  <nav class="nav-menu" id="nav-menu">
    <ul class="nav-list">
      <li><a href="index.html" class="active">MINE</a></li>
      <li><a href="leaders.html">LEADERS</a></li>
      <li><a href="earn.html">EARN</a></li>
      <li><a href="friends.html">FRIENDS</a></li>
      <li><a href="wallet.html">WALLET</a></li>
    </ul>
  </nav>

  <script>
    // -------------------------------------------------
    // Firebase Initialization
    // -------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyAzXSCn_QL2XeyRZD71By443sl4wOtXf2Y",
        authDomain: "pipcore-8844f.firebaseapp.com",
        projectId: "pipcore-8844f",
        storageBucket: "pipcore-8844f.appspot.com",
        messagingSenderId: "921115337984",
        appId: "1:921115337984:web:17161651342ad78017bfe5"
      };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const functions = firebase.functions();

    // -------------------------------------------------
    // Telegram WebApp SDK
    // -------------------------------------------------
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.enableClosingConfirmation();
    }

    // -------------------------------------------------
    // Utility Functions
    // -------------------------------------------------
    function generateDailyCode() {
      return Math.floor(1000000000 + Math.random() * 9000000000).toString();
    }
    function isWithin24Hours(timestamp) {
      return Date.now() - timestamp < 24 * 60 * 60 * 1000;
    }
    function getTodayString() {
      return new Date().toDateString();
    }

    // -------------------------------------------------
    // UI References and Global Variables
    // -------------------------------------------------
    let miningInterval = null;
    const baseMiningRate = 0.003472; // mined per minute
    const usernameDisplay = document.getElementById('username');
    const balanceDisplay = document.getElementById('balance');
    const minedDisplay = document.getElementById('mined');
    const powerDisplay = document.getElementById('power');
    const submissionCountDisplay = document.getElementById('submissionCount');
    const dailyCodeDisplay = document.getElementById('dailyCode');
    const mineButton = document.getElementById('mineButton');
    const submitCodeButton = document.getElementById('submitCodeButton');
    const submitCodeInput = document.getElementById('submitCodeInput');

    // Global data for current user
    let currentUserDoc = null;
    let userData = null;
    let userId = null;

    // -------------------------------------------------
    // Effective Mining Power Calculation & UI Update
    // -------------------------------------------------
    function getEffectivePower() {
      // Base power: 1.0
      // Bonus: +0.5 if the user has submitted a code today
      // Plus +0.1 for each time your daily code has been submitted (max 10 submissions)
      let bonus = 0;
      if (userData.hasSubmittedToday) bonus += 0.5;
      bonus += (userData.submissionsReceived || 0) * 0.1;
      return 1.0 + bonus;
    }
    function updateMiningPowerUI() {
      if (userData) {
        powerDisplay.textContent = getEffectivePower().toFixed(1);
      }
    }
    function updateUI() {
      if (!userData) return;
      balanceDisplay.textContent = userData.balance.toFixed(3);
      minedDisplay.textContent = userData.balance.toFixed(2);
      powerDisplay.textContent = getEffectivePower().toFixed(1);
      dailyCodeDisplay.textContent = userData.dailyCode;
      submissionCountDisplay.textContent = userData.submissionsReceived || 0;
      usernameDisplay.textContent = userData.username || "anonymous";
    }

    // -------------------------------------------------
    // Firebase Authentication (Anonymous)
    // -------------------------------------------------
    auth.signInAnonymously().catch((error) => {
      console.error("Authentication error:", error);
    });
    auth.onAuthStateChanged((user) => {
      if (user) {
        userId = user.uid;
        const userRef = db.collection("users").doc(userId);
        userRef.get().then((docSnapshot) => {
          if (docSnapshot.exists) {
            currentUserDoc = userRef;
            userData = docSnapshot.data();
            // Daily reset: if daily code is not valid, reset daily data.
            if (!userData.dailyCode || !userData.codeTimestamp || !isWithin24Hours(userData.codeTimestamp)) {
              userData.dailyCode = generateDailyCode();
              userData.codeTimestamp = Date.now();
              userData.submissionsReceived = 0;
              userData.hasSubmittedToday = false;
              userData.lastMiningUpdate = Date.now();
              userData.miningPower = 1.0;
              userRef.set(userData);
            }
            updateUI();
          } else {
            // New user setup
            const initialData = {
              username: (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? 
                        "@" + tg.initDataUnsafe.user.username : "anonymous",
              balance: 0,
              miningPower: 1.0,
              dailyCode: generateDailyCode(),
              codeTimestamp: Date.now(),
              submissionsReceived: 0,
              hasSubmittedToday: false,
              lastMiningUpdate: Date.now()
            };
            userRef.set(initialData);
            currentUserDoc = userRef;
            userData = initialData;
            updateUI();
          }
          // Listen for real-time updates to the user's data.
          userRef.onSnapshot((doc) => {
            userData = doc.data();
            updateUI();
          });
        });
      }
    });

    // -------------------------------------------------
    // Mining Functionality
    // -------------------------------------------------
    function updateMiningProgress() {
      if (!userData || !currentUserDoc) return;
      const now = Date.now();
      const elapsedSeconds = (now - userData.lastMiningUpdate) / 1000;
      const increment = (baseMiningRate * getEffectivePower() / 60) * elapsedSeconds;
      // Update Firestore with the new balance and update timestamp.
      currentUserDoc.update({
        balance: firebase.firestore.FieldValue.increment(increment),
        lastMiningUpdate: now
      }).catch((error) => {
        console.error("Error updating mining progress:", error);
      });
    }
    function startMining() {
      if (miningInterval) clearInterval(miningInterval);
      miningInterval = setInterval(updateMiningProgress, 1000);
      mineButton.textContent = "Mining...";
    }
    mineButton.addEventListener('click', () => {
      if (!currentUserDoc) return;
      // Restart the mining process by updating the timestamp.
      currentUserDoc.update({ lastMiningUpdate: Date.now() });
      startMining();
    });

    // -------------------------------------------------
    // Code Submission via Cloud Function
    // -------------------------------------------------
    submitCodeButton.addEventListener('click', () => {
      const submittedCode = submitCodeInput.value.trim();
      if (!/^\d{10}$/.test(submittedCode)) {
        alert("Please enter a valid 10-digit code.");
        return;
      }
      if (submittedCode === userData.dailyCode) {
        alert("You cannot submit your own code.");
        return;
      }
      if (userData.hasSubmittedToday) {
        alert("You have already submitted a code today.");
        return;
      }
      // Call the Cloud Function "submitCode" securely.
      const submitCodeFunction = functions.httpsCallable('submitCode');
      submitCodeFunction({ code: submittedCode })
        .then((result) => {
          alert(result.data.message);
          submitCodeInput.value = "";
        })
        .catch((error) => {
          console.error("Error calling submitCode function:", error);
          alert(error.message);
        });
    });

    // -------------------------------------------------
    // Upgrade Modal Functionality
    // -------------------------------------------------
    const upgradeButton = document.getElementById('upgradeButton');
    const upgradeModal = document.getElementById('upgradeModal');
    const closeModal = document.getElementById('closeModal');
    const buyButtons = document.querySelectorAll('.power-buy');
    upgradeButton.addEventListener('click', () => {
      upgradeModal.classList.add('active');
    });
    closeModal.addEventListener('click', () => {
      upgradeModal.classList.remove('active');
    });
    upgradeModal.addEventListener('click', (e) => {
      if (e.target === upgradeModal) {
        upgradeModal.classList.remove('active');
      }
    });
    buyButtons.forEach(button => {
      button.addEventListener('click', () => {
        const power = parseFloat(button.dataset.power);
        const price = button.dataset.price;
        const powerName = button.closest('.power-option').querySelector('.power-name').textContent;
        if (tg) {
          tg.showPopup({
            title: 'Confirm Purchase',
            message: `Do you want to buy ${powerName} (${power}x power) for ${price} Stars?`,
            buttons: [
              { id: 'cancel', type: 'cancel' },
              { id: 'buy', type: 'default', text: 'Buy' }
            ]
          }, (buttonId) => {
            if (buttonId === 'buy') {
              // Update the user's mining power.
              currentUserDoc.update({ miningPower: power });
              buyButtons.forEach(btn => {
                if (parseFloat(btn.dataset.power) === power) {
                  btn.textContent = 'Purchased';
                  btn.disabled = true;
                  btn.classList.add('purchased');
                } else {
                  btn.textContent = 'Upgrade';
                  btn.disabled = false;
                  btn.classList.remove('purchased');
                }
              });
              tg.showAlert(`Success! You've unlocked ${powerName} (${power}x power).`);
              upgradeModal.classList.remove('active');
            }
          });
        } else {
          if (confirm(`Do you want to buy ${powerName} (${power}x power) for ${price} Stars?`)) {
            currentUserDoc.update({ miningPower: power });
            buyButtons.forEach(btn => {
              if (parseFloat(btn.dataset.power) === power) {
                btn.textContent = 'Purchased';
                btn.disabled = true;
                btn.classList.add('purchased');
              } else {
                btn.textContent = 'Upgrade';
                btn.disabled = false;
                btn.classList.remove('purchased');
              }
            });
            upgradeModal.classList.remove('active');
            alert(`Success! You've unlocked ${powerName} (${power}x power).`);
          }
        }
      });
    });
  </script>
</body>
</html>
