<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>$BLACK</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="header">
    <h1 class="logo">$BLACK</h1>
  </div>

  <div class="container">
    <div class="card global-stats">
      <div class="stats-row">
        <div>Total Mined</div>
        <div><span id="mined">0.00</span> / 100,000,000 $BLACK</div>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">User</h2>
      <div class="stats-row">
        <div>Username</div>
        <div>@<span id="username">loading...</span></div>
      </div>
      <div class="stats-row">
        <div>Balance</div>
        <div><span id="balance">0.000</span> $BLACK</div>
      </div>
      <div class="stats-row">
        <div>Mining Power</div>
        <div>x<span id="power">1.0</span></div>
      </div>
      <button class="button" id="mineButton">Start Mining</button>
    </div>

    <div class="card">
      <div class="stats-row">
        <div>Your Daily Code</div>
        <div><span id="dailyCode">Not generated</span></div>
      </div>
      <h2 class="card-title">Submit a Code</h2>
      <input type="text" id="submitCodeInput" placeholder="Enter 10-digit code" maxlength="10">
      <button class="button" id="submitCodeButton">Submit Code</button>
    </div>

    <div class="countdown" id="countdown">Daily reset in 00:00:00</div>
  </div>

  <nav class="nav-menu" id="nav-menu">
    <ul class="nav-list">
      <li><a href="index.html" class="active"><i class="fas fa-user"></i> MINE</a></li>
      <li><a href="leaders.html"><i class="fas fa-trophy"></i> LEADERS</a></li>          
      <li><a href="earn.html"><i class="fas fa-coins"></i> EARN</a></li>
      <li><a href="friends.html"><i class="fas fa-users"></i> FRIENDS</a></li>
      <li><a href="wallet.html"><i class="fas fa-wallet"></i> WALLET</a></li>
    </ul>
  </nav>

<script>
  // Data storage using localStorage
  const STORAGE_KEY = 'blackMinerData';
  const GLOBAL_STATS_KEY = 'blackMinerGlobalStats';
  
  // Application state
  let currentUser = null;
  let miningInterval = null;
  let dailyResetTimer = null;
  let globalStats = {
    totalMined: 0
  };

  // Initialize the app
  document.addEventListener('DOMContentLoaded', () => {
    loadGlobalStats();
    initializeUser();
    setupEventListeners();
  });

  // Data management functions
  function loadGlobalStats() {
    const savedStats = localStorage.getItem(GLOBAL_STATS_KEY);
    if (savedStats) {
      globalStats = JSON.parse(savedStats);
    }
    updateGlobalStatsUI();
  }

  function saveGlobalStats() {
    localStorage.setItem(GLOBAL_STATS_KEY, JSON.stringify(globalStats));
  }

  function initializeUser() {
    const tg = window.Telegram?.WebApp;
    const username = tg?.initDataUnsafe?.user?.username || 
                     `guest_${Math.floor(Math.random() * 100000)}`;
    
    const savedData = localStorage.getItem(STORAGE_KEY);
    
    if (savedData) {
      currentUser = JSON.parse(savedData);
      
      // Check if 24 hours have passed for daily reset
      const lastReset = new Date(currentUser.codeCreatedAt);
      const now = new Date();
      const hoursSinceReset = (now - lastReset) / 3.6e6;
      
      if (hoursSinceReset >= 24) {
        performDailyReset();
      }
    } else {
      // Create new user
      currentUser = {
        username: username,
        balance: 0,
        power: 1.0,
        minedToday: 0,
        dailyCode: generateCode(),
        codeCreatedAt: new Date().toISOString(),
        codeUses: 0,
        submittedToday: false,
        miningStartTime: null
      };
      saveUserData();
    }
    
    updateUI();
    startDailyResetTimer();
  }

  function saveUserData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentUser));
  }

  // Mining functions
  function startMining() {
    if (miningInterval) return;
    
    // Record start time if not already mining
    if (!currentUser.miningStartTime) {
      currentUser.miningStartTime = new Date().toISOString();
      saveUserData();
    }
    
    // Process mining immediately
    processMining();
    
    // Then set up interval for continuous mining
    miningInterval = setInterval(processMining, 60000); // Every minute
    
    // Update button state
    document.getElementById("mineButton").textContent = "Mining...";
    document.getElementById("mineButton").disabled = true;
  }

  function processMining() {
    const power = currentUser.power;
    const minedPerMin = 0.003472 * power;
    const dailyLimit = 5;
    
    // Calculate minutes since mining started
    const startTime = new Date(currentUser.miningStartTime);
    const now = new Date();
    const minutesMining = (now - startTime) / 60000;
    
    // Calculate potential earnings
    const potentialEarnings = minedPerMin * minutesMining;
    
    // Check if we've hit daily limit
    if (currentUser.minedToday + potentialEarnings >= dailyLimit) {
      stopMining();
      return;
    }
    
    // Update balance
    currentUser.balance += potentialEarnings;
    currentUser.minedToday += potentialEarnings;
    globalStats.totalMined += potentialEarnings;
    
    // Reset mining start time for next interval
    currentUser.miningStartTime = new Date().toISOString();
    
    saveUserData();
    saveGlobalStats();
    updateUI();
  }

  function stopMining() {
    clearInterval(miningInterval);
    miningInterval = null;
    document.getElementById("mineButton").textContent = "Start Mining";
    document.getElementById("mineButton").disabled = false;
  }

  // Code system functions
  function submitCode() {
    const code = document.getElementById("submitCodeInput").value.trim();
    
    if (currentUser.submittedToday) {
      alert("You've already submitted a code today.");
      return;
    }
    
    if (code.length !== 10) {
      alert("Please enter a valid 10-digit code.");
      return;
    }
    
    // In a real app, this would check against other users' codes
    // For demo purposes, we'll just validate format
    if (/^\d{10}$/.test(code)) {
      // Increase user's power
      currentUser.power = Math.min(currentUser.power + 0.5, 2.5);
      currentUser.submittedToday = true;
      
      saveUserData();
      updateUI();
      alert("Code accepted! Your mining power has increased.");
    } else {
      alert("Invalid code format. Please enter a 10-digit number.");
    }
  }

  function generateCode() {
    return Math.random().toString().slice(2, 12);
  }

  // Daily reset functions
  function performDailyReset() {
    currentUser.dailyCode = generateCode();
    currentUser.codeCreatedAt = new Date().toISOString();
    currentUser.codeUses = 0;
    currentUser.submittedToday = false;
    currentUser.minedToday = 0;
    currentUser.power = 1.0;
    currentUser.miningStartTime = null;
    
    saveUserData();
    updateUI();
  }

  function startDailyResetTimer() {
    // Update immediately
    updateResetTimer();
    
    // Then update every second
    dailyResetTimer = setInterval(updateResetTimer, 1000);
  }

  function updateResetTimer() {
    if (!currentUser) return;
    
    const resetTime = new Date(currentUser.codeCreatedAt);
    resetTime.setHours(resetTime.getHours() + 24);
    
    const now = new Date();
    const diff = resetTime - now;
    
    if (diff <= 0) {
      performDailyReset();
      return;
    }
    
    const hours = Math.floor(diff / (1000 * 60 * 60)).toString().padStart(2, '0');
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
    const seconds = Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, '0');
    
    document.getElementById("countdown").textContent = `Daily reset in ${hours}:${minutes}:${seconds}`;
  }

  // UI update functions
  function updateUI() {
    if (!currentUser) return;
    
    document.getElementById("username").textContent = currentUser.username;
    document.getElementById("balance").textContent = currentUser.balance.toFixed(3);
    document.getElementById("power").textContent = currentUser.power.toFixed(1);
    document.getElementById("dailyCode").textContent = currentUser.dailyCode;
    
    // Update mining button if at daily limit
    if (currentUser.minedToday >= 5) {
      document.getElementById("mineButton").textContent = "Daily Limit Reached";
      document.getElementById("mineButton").disabled = true;
      stopMining();
    }
  }

  function updateGlobalStatsUI() {
    document.getElementById("mined").textContent = globalStats.totalMined.toFixed(2);
  }

  // Event listeners
  function setupEventListeners() {
    document.getElementById("mineButton").addEventListener("click", startMining);
    document.getElementById("submitCodeButton").addEventListener("click", submitCode);
  }
</script>
</body>
</html>
