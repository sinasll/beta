<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLACK Mining</title>
    <link href="style.css" rel="stylesheet" type="text/css">

    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

</head>
<body>

  <div class="header">
    <h2>$BLACK</h2>
  </div>

    <div class="container">
        <!-- Token Info Box -->
        <div class="box">
            <div class="stats">
                <div>Supply: 125,000,000</div>
                <div>Mined: <span id="mined">0.00</span></div>
            </div>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
        </div>

  <!-- User Info Box -->
  <div class="box">
    <h2>User Info</h2>
    <div>Username: <span id="username">Loading...</span></div>
    <div>Balance: <span id="balance">0.00</span> $BLACK</div>
    <div>Mining Power: <span id="power">1.0</span>x</div>
</div>

        <!-- Daily Codes Box -->
        <div class="box">
            <h2>Daily Codes</h2>
            <div>Your Code: <span id="code"></span>
                <button onclick="copyCode()">Copy</button>
            </div>
            <div class="code-section">
                <input type="text" id="inputCode" placeholder="Enter code">
                <button onclick="submitCode()">Submit</button>
            </div>
            <div id="codeStatus">
                <div>Expires in: <span id="countdown">00:00:00</span></div>
                <div>Submitted: <span id="submissions">0</span>/10</div>
            </div>
        </div>

        <!-- Mining Button -->
        <div class="box" style="text-align: center">
            <button id="mineButton" onclick="startMining()">Start Mining</button>
        </div>

        <!-- Bottom Navigation -->
        <div class="nav">
            <div class="nav-item">MINE</div>
            <div class="nav-item">TASKS</div>
            <div class="nav-item">FRIENDS</div>
            <div class="nav-item">WALLET</div>
        </div>
    </div>
    <script>
      /**********************
       * 1. Initialize Firebase
       **********************/
      const firebaseConfig = {
        apiKey: "AIzaSyAzXSCn_QL2XeyRZD71By443sl4wOtXf2Y",
        authDomain: "pipcore-8844f.firebaseapp.com",
        projectId: "pipcore-8844f",
        storageBucket: "pipcore-8844f.appspot.com",
        messagingSenderId: "921115337984",
        appId: "1:921115337984:web:17161651342ad78017bfe5"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      let userRef;
      let unsubscribeUser;
      
      /**********************
      * 2. Mining App Variables
      **********************/
      let userId = null;
      const baseRate = 0.003472 / 6; // Adjusted for 10-second intervals
      let miningInterval;
      let countdownInterval;
      
      /**********************
      * 3. User Initialization with Telegram WebApp
      **********************/
      async function initUser() {
        try {
            // Initialize Telegram WebApp
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            
            // Get Telegram user data
            const tgUser = Telegram.WebApp.initDataUnsafe.user;
            if (!tgUser) {
                throw new Error("Telegram user data not available");
            }
            
            userId = `tg_${tgUser.id}`;
            userRef = db.collection('users').doc(userId);
      
            // Check or create user document
            const doc = await userRef.get();
            if (!doc.exists) {
                await userRef.set({
                    telegramId: tgUser.id,
                    telegramUsername: tgUser.username || `user_${tgUser.id}`,
                    firstName: tgUser.first_name,
                    lastName: tgUser.last_name || '',
                    balance: 0,
                    miningPower: 1,
                    uniqueCode: '',
                    submissionsReceived: 0,
                    hasSubmitted: false,
                    miningActive: false,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
      
            // Set up real-time listener
            unsubscribeUser = userRef.onSnapshot(async (doc) => {
                const data = doc.data();
                updateUI(data);
                
                if (data.miningActive) {
                    startCountdown(data.codeExpiration?.toDate());
                    if (!miningInterval) startMiningInterval();
                } else {
                    stopMining();
                }
            });
      
        } catch (e) {
            console.error("Error initializing user:", e);
            // Fallback for testing outside Telegram
            if (!userId) {
                userId = `tg_${Math.floor(Math.random() * 1000000)}`;
                userRef = db.collection('users').doc(userId);
                await userRef.set({
                    telegramUsername: "test_user",
                    balance: 0,
                    miningPower: 1,
                    uniqueCode: '',
                    submissionsReceived: 0,
                    hasSubmitted: false,
                    miningActive: false,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
      }
      
      /**********************
      * 4. Mining Functions
      **********************/
      function calculatePower(data) {
        return 1 + (data.submissionsReceived * 0.1) + (data.hasSubmitted ? 0.5 : 0);
      }
      
      async function startMining() {
        const code = await generateUniqueCode();
        await userRef.update({
            miningActive: true,
            uniqueCode: code,
            codeExpiration: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 86400000)),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      
      async function generateUniqueCode() {
        let code;
        do {
            code = Math.random().toString().slice(2, 12);
            const snapshot = await db.collection('users')
                .where('uniqueCode', '==', code)
                .limit(1)
                .get();
            if (snapshot.empty) return code;
        } while (true);
      }
      
      function startMiningInterval() {
        miningInterval = setInterval(async () => {
            const doc = await userRef.get();
            const data = doc.data();
            const earnings = baseRate * calculatePower(data);
            
            await userRef.update({
                balance: firebase.firestore.FieldValue.increment(earnings),
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }, 10000);
      }
      
      function stopMining() {
        clearInterval(miningInterval);
        miningInterval = null;
      }
      
      /**********************
      * 5. Code Submission
      **********************/
      async function submitCode() {
        const inputCode = document.getElementById('inputCode').value.trim();
        if (!inputCode) return;
      
        try {
            // Check if code exists
            const snapshot = await db.collection('users')
                .where('uniqueCode', '==', inputCode)
                .limit(1)
                .get();
      
            if (snapshot.empty) {
                alert('Invalid code!');
                return;
            }
      
            const codeOwner = snapshot.docs[0];
            if (codeOwner.id === userId) {
                alert("You can't use your own code!");
                return;
            }
      
            // Check daily submissions
            const today = new Date().toISOString().split('T')[0];
            const submissionRef = db.collection('submissions').doc(`${userId}_${today}_${inputCode}`);
            
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(submissionRef);
                if (doc.exists) {
                    alert('Already submitted this code today!');
                    return;
                }
      
                transaction.set(submissionRef, {
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
      
                transaction.update(userRef, {
                    hasSubmitted: true,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
      
                transaction.update(codeOwner.ref, {
                    submissionsReceived: firebase.firestore.FieldValue.increment(1),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
      
                alert('Code submitted successfully!');
            });
        } catch (error) {
            console.error('Submission error:', error);
        }
      }
      
      /**********************
      * 6. UI Functions
      **********************/
      function updateUI(data) {
        if (!data) return;
        
        // Display Telegram username or first name
        const displayName = data.telegramUsername || data.firstName || 'User';
        document.getElementById('username').textContent = `@${displayName}`;
        document.getElementById('balance').textContent = data.balance?.toFixed(2) || '0.00';
        document.getElementById('power').textContent = calculatePower(data).toFixed(1);
        document.getElementById('code').textContent = data.uniqueCode || '';
        document.getElementById('submissions').textContent = data.submissionsReceived || 0;
        document.getElementById('mineButton').disabled = !!data.miningActive;
        document.getElementById('mineButton').textContent = data.miningActive ? 'Mining...' : 'Start Mining';
        updateProgress(data.balance || 0);
      }
      
      function updateProgress(balance) {
        const progress = (balance / 125000000) * 100;
        document.getElementById('progress').style.width = `${progress}%`;
        document.getElementById('mined').textContent = balance.toFixed(2);
      }
      
      function startCountdown(expiration) {
        clearInterval(countdownInterval);
        if (!expiration) return;
      
        countdownInterval = setInterval(() => {
            const now = new Date();
            const diff = expiration - now;
            
            if (diff <= 0) {
                clearInterval(countdownInterval);
                userRef.update({ miningActive: false });
                return;
            }
      
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            document.getElementById('countdown').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
      }
      
      function copyCode() {
        const code = document.getElementById('code').textContent;
        if (!code) return;
        
        navigator.clipboard.writeText(code).then(() => {
            alert('Code copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy code: ', err);
        });
      }
      
      /**********************
      * 7. Initialization
      **********************/
      document.addEventListener('DOMContentLoaded', initUser);
      window.addEventListener('beforeunload', () => {
        if (unsubscribeUser) unsubscribeUser();
        stopMining();
      });
          </script>
</body>
</html>