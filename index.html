<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>$BLACK Mining</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Appwrite Web SDK -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@17.0.1"></script>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="header">
    <h1 class="logo">$BLACK</h1>
  </div>

  <div class="container">
    <!-- Global Stats -->
    <div class="card global-stats">
      <div class="stats-row">
        <div>Total Mined</div>
        <div><span id="mined">0.00</span> / 100,000,000 $BLACK</div>
      </div>
      <div class="stats-row">
        <div>Total Miners</div>
        <div><span id="totalminers">0</span></div>
      </div>
    </div>

    <!-- User Stats -->
    <div class="card">
      <h2 class="card-title">User</h2>
      <div class="stats-row">
        <div>Username</div>
        <div><span id="username">username</span></div>
      </div>
      <div class="stats-row">
        <div>Balance</div>
        <div><span id="balance">0.000</span> $BLACK</div>
      </div>
      <div class="stats-row">
        <div>Mining Power</div>
        <div>x<span id="power">1.0</span></div>
      </div>
      <div class="stats-row">
        <div>Your Code Submissions</div>
        <div><span id="submissionCount">0</span>/10</div>
      </div>
      <button class="button" id="upgradeButton">Upgrade Power</button>
      <button class="button" id="mineButton">Start Mining</button>
    </div>

    <!-- Daily Code Section -->
    <div class="card">
      <div class="stats-row">
        <h2 class="card-title">Daily Code</h2>
        <div><span id="dailyCode">XXXXXXXXXX</span></div>
      </div>
      <button class="button" id="copyCodeButton">Copy Code</button>
      <input type="text" id="submitCodeInput" placeholder="Enter 10-digit code" maxlength="10" />
      <button class="button" id="submitCodeButton">Submit Code</button>
    </div>

    <div class="countdown" id="countdown">Daily reset in 00:00:00</div>
  </div>

  <!-- Navigation Menu -->
  <nav class="nav-menu" id="nav-menu">
    <ul class="nav-list">
      <li><a href="index.html" class="active">MINE</a></li>
      <li><a href="leaders.html">LEADERS</a></li>
      <li><a href="earn.html">EARN</a></li>
      <li><a href="friends.html">FRIENDS</a></li>
      <li><a href="wallet.html">WALLET</a></li>
    </ul>
  </nav>

  <!-- Inline JavaScript -->
  <script>
    // Wait until the DOM content is fully loaded
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize Telegram WebApp
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();

      // Verify that both Appwrite and Telegram SDKs are loaded
      if (!window.Appwrite || !window.Telegram) {
        Telegram.WebApp.showAlert("Error: Required SDKs failed to load. Please restart.");
        return;
      }

      // Initialize the Appwrite client
      const client = new Appwrite.Client();
      client
        .setEndpoint('https://cloud.appwrite.io/v1')
        .setProject('67fc2c5c002c9c00f778');

      // Add a click event listener to the "Start Mining" button
      document.getElementById('mineButton').addEventListener('click', async () => {
        try {
          // Show loading state on Telegram's Main Button
          Telegram.WebApp.MainButton.showProgress();

          // Extract the user ID from Telegram initialization data
          const userId = Telegram.WebApp.initDataUnsafe.user.id.toString();

          // Call the Appwrite function by sending a POST request
          const response = await fetch('https://67fc399b4d05399fae0f.appwrite.global/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Telegram-Init-Data': Telegram.WebApp.initData
            },
            body: JSON.stringify({ userId })
          });

          if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

          const result = await response.json();

          if (result.success) {
            // On success, update the daily code in the UI and show an alert
            document.getElementById('dailyCode').textContent = result.code;
            Telegram.WebApp.showAlert("Mining started successfully!");
          } else {
            throw new Error(result.error || "Failed to start mining");
          }
        } catch (error) {
          // Show an error alert if something goes wrong
          Telegram.WebApp.showAlert(`Error: ${error.message}`);
          console.error("Mining error:", error);
        } finally {
          // Hide the loading state when done
          Telegram.WebApp.MainButton.hideProgress();
        }
      });
    });
  </script>
  
</body>
</html>
