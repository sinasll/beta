<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>$BLACK</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/appwrite@17.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@17.0.1/query.js"></script>
</head>
<body>
  <div class="header">
    <h1 class="logo">$BLACK</h1>
  </div>

  <div class="container">
    <div class="card global-stats">
      <div class="stats-row">
        <div>Total Mined</div>
        <div><span id="mined">0.00</span> / 100,000,000 $BLACK</div>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">User</h2>
      <div class="stats-row">
        <div>Username</div>
        <div>@<span id="username">blackminer</span></div>
      </div>
      <div class="stats-row">
        <div>Balance</div>
        <div><span id="balance">0.000</span> $BLACK</div>
      </div>
      <div class="stats-row">
        <div>Mining Power</div>
        <div>x<span id="power">1.0</span></div>
      </div>
      <div class="stats-row">
        <div>Your Daily Code</div>
        <div><span id="dailyCode">Not generated</span></div>
      </div>
      <button class="button" id="mineButton">Start Mining</button>
    </div>

    <div class="card">
      <h2 class="card-title">Submit a Code</h2>
      <input type="text" id="submitCodeInput" placeholder="Enter 10-digit code" maxlength="10">
      <button class="button" id="submitCodeButton">Submit Code</button>
    </div>

    <div class="countdown" id="countdown">Daily reset in 00:00:00</div>
  </div>

  <nav class="nav-menu" id="nav-menu">
    <ul class="nav-list">
      <li><a href="index.html" class="active"><i class="fas fa-user"></i> MINE</a></li>
      <li><a href="leaders.html"><i class="fas fa-trophy"></i> LEADERS</a></li>          
      <li><a href="earn.html"><i class="fas fa-coins"></i> EARN</a></li>
      <li><a href="friends.html"><i class="fas fa-users"></i> FRIENDS</a></li>
      <li><a href="wallet.html"><i class="fas fa-wallet"></i> WALLET</a></li>        
    </ul>
  </nav>

  <script>
    // Initialize Appwrite
    const client = new Appwrite.Client()
      .setEndpoint('https://cloud.appwrite.io/v1')
      .setProject('beta90miniapp');

    const databases = new Appwrite.Databases(client);
    const account = new Appwrite.Account(client);

    // Appwrite database constants
    const DATABASE_ID = '67f7015c00091f3a61da';
    const COLLECTION_ID = '67f70164003d1cd73e93';

    // Check if running in Telegram
    if (!window.Telegram || !window.Telegram.WebApp) {
      alert('This app must be run within Telegram');
      throw new Error('Telegram WebApp not detected');
    }

    // Telegram Web App initialization
    const tg = window.Telegram.WebApp;
    tg.expand();

    // User state
    let currentUser = null;
    let miningInterval = null;

    async function initApp() {
      try {
        // Telegram authentication
        const session = await account.createSession('telegram', {
          initData: tg.initData
        });

        try {
          currentUser = await databases.getDocument(
            DATABASE_ID,
            COLLECTION_ID,
            tg.initDataUnsafe.user.id.toString()
          );
        } catch (error) {
          // Create new user if doesn't exist
          currentUser = await databases.createDocument(
            DATABASE_ID,
            COLLECTION_ID,
            tg.initDataUnsafe.user.id.toString(),
            {
              username: tg.initDataUnsafe.user.username || `user_${Math.random().toString(36).substring(2, 8)}`,
              balance: 0.0,
              mining_power: 1.0,
              daily_code: generateDailyCode(),
              invited_friends: 0,
              last_mine: null
            }
          );
        }

        updateUI();
        setupMining();
        setupCodeSubmission();
        setupCountdown();
      } catch (error) {
        console.error('Initialization error:', error);
        tg.showAlert('Failed to initialize app. Please try again.');
      }
    }

    function updateUI() {
      if (!currentUser) return;

      document.getElementById('username').textContent = currentUser.username;
      document.getElementById('balance').textContent = currentUser.balance.toFixed(3);
      document.getElementById('power').textContent = currentUser.mining_power.toFixed(1);
      document.getElementById('dailyCode').textContent = currentUser.daily_code || 'Not generated';
    }

    function generateDailyCode() {
      return Math.random().toString(36).slice(2, 12).toUpperCase();
    }

    function setupMining() {
      const mineButton = document.getElementById('mineButton');

      mineButton.addEventListener('click', async () => {
        if (!miningInterval) {
          mineButton.textContent = 'Mining...';
          mineButton.disabled = true;

          // Start mining immediately
          await mineOnce();

          // Then set up interval
          miningInterval = setInterval(mineOnce, 1000);
          mineButton.disabled = false;
        } else {
          clearInterval(miningInterval);
          miningInterval = null;
          mineButton.textContent = 'Start Mining';
        }
      });

      async function mineOnce() {
        try {
          if (!currentUser) return;

          const newBalance = currentUser.balance + (0.1 * currentUser.mining_power);

          await databases.updateDocument(
            DATABASE_ID,
            COLLECTION_ID,
            currentUser.$id,
            {
              balance: newBalance,
              last_mine: new Date().toISOString()
            }
          );

          // Refresh user data
          currentUser = await databases.getDocument(
            DATABASE_ID,
            COLLECTION_ID,
            currentUser.$id
          );

          updateUI();
        } catch (error) {
          console.error('Mining error:', error);
          clearInterval(miningInterval);
          miningInterval = null;
          document.getElementById('mineButton').textContent = 'Start Mining';
          tg.showAlert('Mining failed. Please try again.');
        }
      }
    }

    function setupCodeSubmission() {
      const submitButton = document.getElementById('submitCodeButton');
      const codeInput = document.getElementById('submitCodeInput');

      submitButton.addEventListener('click', async () => {
        const inputCode = codeInput.value.toUpperCase().trim();

        if (!inputCode || inputCode.length !== 10) {
          tg.showAlert('Please enter a valid 10-digit code');
          return;
        }

        if (!currentUser) {
          tg.showAlert('User not initialized');
          return;
        }

        if (inputCode === currentUser.daily_code) {
          tg.showAlert("You can't use your own code!");
          return;
        }

        try {
          // Find code owner
          const codeOwner = await databases.listDocuments(
            DATABASE_ID,
            COLLECTION_ID,
            [Query.equal('daily_code', inputCode)]
          );

          if (codeOwner.documents.length === 0) {
            tg.showAlert('Invalid code! No user found with this code.');
            return;
          }

          const owner = codeOwner.documents[0];

          // Update both users
          await Promise.all([
            databases.updateDocument(
              DATABASE_ID,
              COLLECTION_ID,
              currentUser.$id,
              { balance: currentUser.balance + 500 }
            ),
            databases.updateDocument(
              DATABASE_ID,
              COLLECTION_ID,
              owner.$id,
              { 
                balance: owner.balance + 500,
                daily_code: generateDailyCode() // Reset owner's code
              }
            )
          ]);

          // Refresh current user
          currentUser = await databases.getDocument(
            DATABASE_ID,
            COLLECTION_ID,
            currentUser.$id
          );

          updateUI();
          tg.showAlert('Code accepted! +500 $BLACK for both users');
          codeInput.value = '';
        } catch (error) {
          console.error('Code submission error:', error);
          tg.showAlert('Error processing code. Please try again.');
        }
      });
    }

    function setupCountdown() {
      function update() {
        const now = new Date();
        const nextUTCMidnight = new Date();
        nextUTCMidnight.setUTCHours(24, 0, 0, 0);

        let diff = nextUTCMidnight - now;
        if (diff < 0) {
          nextUTCMidnight.setUTCDate(nextUTCMidnight.getUTCDate() + 1);
          diff = nextUTCMidnight - now;
        }

        const hours = Math.floor(diff / 3600000).toString().padStart(2, '0');
        const minutes = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
        const seconds = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');

        document.getElementById('countdown').textContent = 
          `Daily reset in ${hours}:${minutes}:${seconds}`;
      }

      setInterval(update, 1000);
      update();
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      initApp();
    });
  </script>
</body>
</html>