<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>$BLACK Mining</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Appwrite Web SDK -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@17.0.1"></script>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="header">
    <h1 class="logo">$BLACK</h1>
  </div>

  <div class="container">
    <!-- Global Stats -->
    <div class="card global-stats">
      <div class="stats-row">
        <div>Total Mined</div>
        <div><span id="mined">0.00</span> / 100,000,000 $BLACK</div>
      </div>
      <div class="stats-row">
        <div>Total Miners</div>
        <div><span id="totalminers">0</span></div>
      </div>
    </div>

    <!-- User Stats -->
    <div class="card">
      <h2 class="card-title">User</h2>
      <div class="stats-row">
        <div>Username</div>
        <div><span id="username">username</span></div>
      </div>
      <div class="stats-row">
        <div>Balance</div>
        <div><span id="balance">0.000</span> $BLACK</div>
      </div>
      <div class="stats-row">
        <div>Mining Power</div>
        <div>x<span id="power">1.0</span></div>
      </div>
      <div class="stats-row">
        <div>Your Code Submissions</div>
        <div><span id="submissionCount">0</span>/10</div>
      </div>
      <button class="button" id="upgradeButton">Upgrade Power</button>
      <button class="button" id="mineButton">Start Mining</button>
    </div>

    <!-- Daily Code Section -->
    <div class="card">
      <div class="stats-row">
        <h2 class="card-title">Daily Code</h2>
        <div><span id="dailyCode">XXXXXXXXXX</span></div>
      </div>
      <button class="button" id="copyCodeButton">Copy Code</button>
      <input type="text" id="submitCodeInput" placeholder="Enter 10-digit code" maxlength="10" />
      <button class="button" id="submitCodeButton">Submit Code</button>
    </div>

    <div class="countdown" id="countdown">Daily reset in 00:00:00</div>
  </div>

  <!-- Navigation Menu -->
  <nav class="nav-menu" id="nav-menu">
    <ul class="nav-list">
      <li><a href="index.html" class="active">MINE</a></li>
      <li><a href="leaders.html">LEADERS</a></li>
      <li><a href="earn.html">EARN</a></li>
      <li><a href="friends.html">FRIENDS</a></li>
      <li><a href="wallet.html">WALLET</a></li>
    </ul>
  </nav>

  <!-- Inline JavaScript -->
  <script>
    // Global variables
    let miningInterval;
    let currentUser = null;
    let userBalance = 0;
    let miningPower = 1.0;

    // Wait until the DOM content is fully loaded
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Initialize Telegram WebApp
        if (!window.Telegram || !Telegram.WebApp) {
          throw new Error("Telegram WebApp SDK not loaded");
        }
        
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.enableClosingConfirmation();

        // Initialize user data
        currentUser = Telegram.WebApp.initDataUnsafe.user;
        if (!currentUser || !currentUser.id) {
          throw new Error("User not authenticated");
        }

        document.getElementById('username').textContent = 
          currentUser.username || `${currentUser.first_name}${currentUser.last_name ? ' ' + currentUser.last_name : ''}`;

        // Initialize Appwrite client
        if (!window.Appwrite) {
          throw new Error("Appwrite SDK not loaded");
        }

        const client = new Appwrite.Client()
          .setEndpoint('https://cloud.appwrite.io/v1')
          .setProject('67fc2c5c002c9c00f778');

        // Load initial user data
        await loadUserData();

        // Button event listeners
        document.getElementById('mineButton').addEventListener('click', toggleMining);
        document.getElementById('upgradeButton').addEventListener('click', upgradePower);
        document.getElementById('copyCodeButton').addEventListener('click', copyDailyCode);
        document.getElementById('submitCodeButton').addEventListener('click', submitCode);

        // Start countdown timer
        updateCountdown();
        setInterval(updateCountdown, 1000);

      } catch (error) {
        console.error("Initialization error:", error);
        showError(error.message);
      }
    });

    // Load user data from Appwrite
    async function loadUserData() {
      try {
        const response = await fetch('https://67fc399b4d05399fae0f.appwrite.global/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Appwrite-Project': '67fc2c5c002c9c00f778',
            'X-Appwrite-Key': 'standard_61995e5422f330e2eb0d95c43552731e8d6c8400cf78414f05e53f9d0360e722d60a982595bc26dd4381a26cfdcf03ccf803e4d6687c878424eacf9fbe94dede144b6d6f450dc02e054bbdca42954652081ba5dd626c713dd6fac896246ffb75d1a82789fd520fed01bb098db7b7ba0214b5d5b83e06f9be916f2be2bc5e8848'
          },
          body: JSON.stringify({ 
            userId: currentUser.id.toString(),
            action: 'getUserData'
          })
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          updateUI(result.data);
        } else {
          throw new Error(result.error || "Failed to load user data");
        }
      } catch (error) {
        console.error("Load user data error:", error);
        showError(error.message);
      }
    }

    // Toggle mining state
    async function toggleMining() {
      const mineButton = document.getElementById('mineButton');
      
      if (miningInterval) {
        // Stop mining
        clearInterval(miningInterval);
        miningInterval = null;
        mineButton.textContent = 'Start Mining';
        Telegram.WebApp.showAlert("Mining stopped");
      } else {
        // Start mining
        mineButton.textContent = 'Stop Mining';
        Telegram.WebApp.MainButton.showProgress();
        
        try {
          const response = await fetch('https://67fc399b4d05399fae0f.appwrite.global/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Appwrite-Project': '67fc2c5c002c9c00f778',
              'X-Appwrite-Key': 'standard_61995e5422f330e2eb0d95c43552731e8d6c8400cf78414f05e53f9d0360e722d60a982595bc26dd4381a26cfdcf03ccf803e4d6687c878424eacf9fbe94dede144b6d6f450dc02e054bbdca42954652081ba5dd626c713dd6fac896246ffb75d1a82789fd520fed01bb098db7b7ba0214b5d5b83e06f9be916f2be2bc5e8848'
            },
            body: JSON.stringify({ 
              userId: currentUser.id.toString(),
              action: 'startMining'
            })
          });

          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }

          const result = await response.json();
          
          if (result.success) {
            updateUI(result.data);
            miningInterval = setInterval(updateMining, 1000);
            Telegram.WebApp.showAlert("Mining started successfully!");
          } else {
            throw new Error(result.error || "Failed to start mining");
          }
        } catch (error) {
          console.error("Mining error:", error);
          showError(error.message);
          mineButton.textContent = 'Start Mining';
        } finally {
          Telegram.WebApp.MainButton.hideProgress();
        }
      }
    }

    // Update mining progress
    async function updateMining() {
      try {
        const response = await fetch('https://67fc399b4d05399fae0f.appwrite.global/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Appwrite-Project': '67fc2c5c002c9c00f778',
            'X-Appwrite-Key': 'standard_61995e5422f330e2eb0d95c43552731e8d6c8400cf78414f05e53f9d0360e722d60a982595bc26dd4381a26cfdcf03ccf803e4d6687c878424eacf9fbe94dede144b6d6f450dc02e054bbdca42954652081ba5dd626c713dd6fac896246ffb75d1a82789fd520fed01bb098db7b7ba0214b5d5b83e06f9be916f2be2bc5e8848'
          },
          body: JSON.stringify({ 
            userId: currentUser.id.toString(),
            action: 'updateMining'
          })
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          updateUI(result.data);
        } else {
          throw new Error(result.error || "Mining update failed");
        }
      } catch (error) {
        console.error("Update mining error:", error);
        showError(error.message);
      }
    }

    // Upgrade mining power
    async function upgradePower() {
      const upgradeButton = document.getElementById('upgradeButton');
      upgradeButton.disabled = true;
      Telegram.WebApp.MainButton.showProgress();

      try {
        const response = await fetch('https://67fc399b4d05399fae0f.appwrite.global/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Appwrite-Project': '67fc2c5c002c9c00f778',
            'X-Appwrite-Key': 'standard_61995e5422f330e2eb0d95c43552731e8d6c8400cf78414f05e53f9d0360e722d60a982595bc26dd4381a26cfdcf03ccf803e4d6687c878424eacf9fbe94dede144b6d6f450dc02e054bbdca42954652081ba5dd626c713dd6fac896246ffb75d1a82789fd520fed01bb098db7b7ba0214b5d5b83e06f9be916f2be2bc5e8848'
          },
          body: JSON.stringify({ 
            userId: currentUser.id.toString(),
            action: 'upgradePower'
          })
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          updateUI(result.data);
          Telegram.WebApp.showAlert("Power upgraded successfully!");
        } else {
          throw new Error(result.error || "Failed to upgrade power");
        }
      } catch (error) {
        console.error("Upgrade error:", error);
        showError(error.message);
      } finally {
        upgradeButton.disabled = false;
        Telegram.WebApp.MainButton.hideProgress();
      }
    }

    // Copy daily code to clipboard
    function copyDailyCode() {
      const code = document.getElementById('dailyCode').textContent;
      navigator.clipboard.writeText(code)
        .then(() => Telegram.WebApp.showAlert("Code copied to clipboard!"))
        .catch(err => showError("Failed to copy code: " + err.message));
    }

    // Submit a friend's code
    async function submitCode() {
      const codeInput = document.getElementById('submitCodeInput');
      const code = codeInput.value.trim();
      
      if (!code || code.length !== 10) {
        showError("Please enter a valid 10-digit code");
        return;
      }

      const submitButton = document.getElementById('submitCodeButton');
      submitButton.disabled = true;
      Telegram.WebApp.MainButton.showProgress();

      try {
        const response = await fetch('https://67fc399b4d05399fae0f.appwrite.global/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Appwrite-Project': '67fc2c5c002c9c00f778',
            'X-Appwrite-Key': 'standard_61995e5422f330e2eb0d95c43552731e8d6c8400cf78414f05e53f9d0360e722d60a982595bc26dd4381a26cfdcf03ccf803e4d6687c878424eacf9fbe94dede144b6d6f450dc02e054bbdca42954652081ba5dd626c713dd6fac896246ffb75d1a82789fd520fed01bb098db7b7ba0214b5d5b83e06f9be916f2be2bc5e8848'
          },
          body: JSON.stringify({ 
            userId: currentUser.id.toString(),
            action: 'submitCode',
            code: code
          })
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          updateUI(result.data);
          codeInput.value = '';
          Telegram.WebApp.showAlert("Code submitted successfully!");
        } else {
          throw new Error(result.error || "Failed to submit code");
        }
      } catch (error) {
        console.error("Submit code error:", error);
        showError(error.message);
      } finally {
        submitButton.disabled = false;
        Telegram.WebApp.MainButton.hideProgress();
      }
    }

    // Update countdown timer
    function updateCountdown() {
      const now = new Date();
      const midnight = new Date();
      midnight.setHours(24, 0, 0, 0);
      
      const diff = midnight - now;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      
      document.getElementById('countdown').textContent = 
        `Daily reset in ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Update UI with new data
    function updateUI(data) {
      if (data.balance !== undefined) {
        userBalance = data.balance;
        document.getElementById('balance').textContent = userBalance.toFixed(3);
      }
      
      if (data.power !== undefined) {
        miningPower = data.power;
        document.getElementById('power').textContent = miningPower.toFixed(1);
      }
      
      if (data.dailyCode) {
        document.getElementById('dailyCode').textContent = data.dailyCode;
      }
      
      if (data.submissionCount !== undefined) {
        document.getElementById('submissionCount').textContent = data.submissionCount;
      }
    }

    // Show error message
    function showError(message) {
      Telegram.WebApp.showPopup({
        title: 'Error',
        message: message,
        buttons: [{ id: 'ok', type: 'default' }]
      });
    }
  </script>
</body>
</html>
